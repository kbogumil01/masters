uÅ¼yjÄ™ vvenc do kodowania i VTM do dekodowania i wysnucia wszystkich parametrÃ³w

uÅ¼ycie:

PATH:
declare -x PATH="/home/karol/mgr/new_PC/vvenc/bin/release-static:/home/karol/mgr/new_PC/vvenc/bin/release-static:/home/karol/.vscode-server/bin/488a1f239235055e34e673291fb8d8c810886f81/bin/remote-cli:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/usr/lib/wsl/lib:/mnt/c/WINDOWS/system32:/mnt/c/WINDOWS:/mnt/c/WINDOWS/System32/Wbem:/mnt/c/WINDOWS/System32/WindowsPowerShell/v1.0/:/mnt/c/WINDOWS/System32/OpenSSH/:/mnt/c/Program Files/NVIDIA Corporation/NVIDIA App/NvDLISR:/mnt/c/Program Files (x86)/NVIDIA Corporation/PhysX/Common:/mnt/c/Users/Karol/AppData/Local/Microsoft/WindowsApps:/mnt/c/Users/Karol/AppData/Local/Programs/Microsoft VS Code/bin:/snap/bin:/home/karol/.vscode-server/data/User/globalStorage/github.copilot-chat/debugCommand"

enkoder:
vvencapp -i ./videos/data/input.yuv  -s 1280x720 -r 50 -o ./videos/encoded/out.vvc

enkoder VTM:
./VTM/bin/EncoderAppStatic -c ./VTM/cfg/encoder_intra_vtm.cfg -i ./videos/data/input.yuv -b ./videos/encoded/VTM_test.vvc -o ./videos/encoded/recon_VTM.yuv --SourceWidth=1280 --SourceHeight=720 --FrameRate=50 --QP=32 --FramesToBeEncoded=64

dekoder VTM:
./VTM/bin/DecoderAppStatic -b ./videos/encoded/out.vvc -o ./videos/decoded/input_test_decoded.yuv

dekoder VTM z flagami do statystyk:
./VTM/bin/DecoderAppStatic -b ./videos/encoded/out.vvc -o ./videos/decoded/input_test_decoded.yuv \
--TraceFile="./videos/decoded/test.vtmbmsstats" \
--TraceRule="D_BLOCK_STATISTICS_CODED:poc>=0"

vvdec:
karol@DESKTOP-PHMBQ6U:~/mgr/new_PC/vvdec$ export PATH=$PWD/bin/release-static:$PATH
vvdecapp -b ./videos/encoded/out.vvc -o ./videos/decoded/test_vvdec.yuv 

ffplay -video_size 1280x720 -framerate 50 -pixel_format yuv420p data/input.yuv


ffplay -video_size 1280x720 -framerate 50 -pixel_format yuv420p10le videos/decoded/test_vvdec.yuv - to dziaÅ‚a git!!!!!!

vvenc â€“ domyÅ›lnie produkuje strumieÅ„ Main10 (10 bitÃ³w).
vvdec / VTM â€“ wypisujÄ… plik YUV w 16-bit LE (10 bitÃ³w
zapakowanych w 16).
ffplay -yuv420p zakÅ‚ada, Å¼e kaÅ¼da prÃ³ba to 8 bitÃ³w â†’ odczytuje tylko
niÅ¼szy bajt kaÅ¼dej pary, gubi chromÄ™, stÄ…d zielone smugi.



oba dekodery dziaÅ‚ajÄ… tak samo, czyli sÅ‚abo bo jest zielony migajÄ…cy obrazek. Jest problem z jakimÅ› parametrem. albo formatem

zadanie: skompiluj VTM dekoder Å¼eby dawaÅ‚ kaÅ¼de poÅ¼Ä…dane info 
: trzeba bÄ™dzie dodaÄ‡ ten shit z wspÃ³Å‚czynnikami

O co cho z wspÃ³Å‚czynnikami:
wspÃ³Å‚czynniki opisujÄ… zawartoÅ›Ä‡ obrazu

zdekwantowane to te po DCT (albo innej metodzie) czyli juÅ¼ te zaokrÄ…glone 

czyli muszÄ™ mieÄ‡ wspÃ³Å‚czynniki przypisane do kaÅ¼dego bloku 

Blok pikseli â†’ Kodek bierze np. blok 16Ã—16 prÃ³bek resztkowych (rÃ³Å¼nicy miÄ™dzy predykcjÄ… a oryginaÅ‚em).




VTM coÅ› wypluÅ‚!!!!!

karol@DESKTOP-PHMBQ6U:~/mgr/new_PC/videos/decoded$ ../../VVCSoftware_VTM/bin/DecoderAppStatic   -b ../encoded/out.vvc   -o recon.yuv   -d 8   --TraceFile=block_stats.csv   --TraceRule="D_BLOCK_STATISTICS_ALL:poc>=0"

-d 8 â€“ jeÅ›li materiaÅ‚ jest 8-bit (typowe dla vvencapp). Dla 10-bit uÅ¼yj -d 10. - chat 2025

czym sÄ… poc?

picture order count - nie wszyskie poc majÄ… dekwantyzacjÄ™! to jest spoko 

CBF w kontekÅ›cie VVC (i wczeÅ›niejszych standardÃ³w jak HEVC, AVC) to skrÃ³t od Coded Block Flag.
Jest to flaga, ktÃ³ra mÃ³wi, czy w danym bloku (dla danego komponentu â€” Y, Cb, Cr) sÄ… niezerowe wspÃ³Å‚czynniki transformaty po kwantyzacji.
JeÅ›li CBF = 1 â†’ blok ma jakieÅ› wspÃ³Å‚czynniki â‰  0 â†’ trzeba go dekwantyzowaÄ‡ i rekonstruowaÄ‡ resztÄ™.

JeÅ›li CBF = 0 â†’ wszystkie wspÃ³Å‚czynniki sÄ… zerowe â†’ oznacza to, Å¼e predykcja (intra lub inter) byÅ‚a tak dobra, Å¼e reszta = 0 â†’ nie ma tu nic do dekwantyzowania (dlatego w Twoim dumpie brak pliku dla POC, jeÅ›li w caÅ‚ej klatce wszystkie CBF=0).



PLAN:


1ï¸âƒ£ Analiza obecnego rozwiÄ…zania Piotra
Cel: zrozumieÄ‡, jak dane idÄ… od surowego wideo do wejÅ›cia sieci.

Å¹rÃ³dÅ‚a danych:
Piotr uÅ¼ywaÅ‚ vvenc/vvdec do kodowania i dekodowania â†’ zapisywaÅ‚ zdekodowane YUV oraz CSV z Block Statistics.

Format wejÅ›ciowy do sieci:
Dataset Å‚adowaÅ‚ zakodowaneâ€“zdekodowane bloki (chunks), oryginalne bloki (orig_chunks) i opcjonalne metadane (raczej ubogie).

BrakujÄ…ce elementy:
brak map CTU/CU, brak QP per blok, brak flag filtrÃ³w (SAO, ALF), brak trybÃ³w predykcji, brak zdekwantowanych wspÃ³Å‚czynnikÃ³w.

2ï¸âƒ£ Projekt nowego pipeline danych
BÄ™dziemy potrzebowali dwÃ³ch gÅ‚Ã³wnych ÅºrÃ³deÅ‚ danych:

block_stats.csv z VTM (z opcjÄ… ENABLE_TRACING, K0149_BLOCK_STATISTICS, BLOCK_STATS_AS_CSV=1):

gÅ‚Ä™bokoÅ›Ä‡ (Depth, QT_Depth, BT_Depth, MT_Depth),

QP (QP, QP_Chroma),

tryby predykcji (PredMode, Luma_IntraMode, Chroma_IntraMode),

flagi filtrÃ³w (SAO, ALF â€“ musimy potwierdziÄ‡, gdzie dokÅ‚adnie sÄ… w CSV),

inne przydatne flagi (SkipFlag, RootCbf, Cbf_Y/Cb/Cr).

Zdekwantowane wspÃ³Å‚czynniki z VTM:

wyciÄ…gniÄ™te z naszego zmodyfikowanego TrQuant::xDeQuant w postaci .bin + .csv z metadanymi bloku,

do konwersji na mapy w dziedzinie przestrzennej lub jako surowe bloki wspÃ³Å‚czynnikÃ³w.

3ï¸âƒ£ WstÄ™pne przetwarzanie
Stworzymy moduÅ‚ preprocessingu, ktÃ³ry:

czyta plik .yuv (rekonstrukcjÄ™) â†’ gÅ‚Ã³wny kanaÅ‚ wejÅ›ciowy,

czyta block_stats.csv i generuje:

mapÄ™ gÅ‚Ä™bokoÅ›ci (depth map),

mapÄ™ QP (per piksel lub per CTU),

mapy flag filtrÃ³w (binarne maski: SAO_on/off, ALF_on/off),

mapy trybÃ³w predykcji (Intra / Inter / konkretne tryby Intra),

czyta nasze pliki dequant_poc_X.bin i przypisuje wspÃ³Å‚czynniki do odpowiednich pozycji w ramce.

ğŸ“Œ Wszystko zostanie zsynchronizowane po POC, Å¼eby ramka i jej cechy siÄ™ zgadzaÅ‚y.

4ï¸âƒ£ Nowa struktura danych w dataset
Rozszerzymy dataset tak, aby:

wejÅ›cie do sieci miaÅ‚o wiÄ™cej kanaÅ‚Ã³w:
[Y, U, V, depth, QP, SAO_flag, ALF_flag, pred_mode, coeff_energy, ...]

kaÅ¼dy kanaÅ‚ bÄ™dzie dopasowany przestrzennie do chunku.

bÄ™dzie moÅ¼na Å‚atwo wÅ‚Ä…czaÄ‡/wyÅ‚Ä…czaÄ‡ poszczegÃ³lne cechy (do eksperymentÃ³w).

5ï¸âƒ£ Modyfikacja sieci neuronowej
W enhancer.py (lub analogicznym modelu) zwiÄ™kszamy liczbÄ™ kanaÅ‚Ã³w wejÅ›ciowych.

MoÅ¼emy zastosowaÄ‡ early fusion (wszystkie kanaÅ‚y jako wejÅ›cie konwolucji) lub late fusion (oddzielna Å›cieÅ¼ka dla cech, potem Å‚Ä…czenie).

Sprawdzimy, czy dodatkowe cechy poprawiajÄ… metryki PSNR/SSIM/VMAF.

6ï¸âƒ£ Etapy implementacji
Etap 1 â€“ wÅ‚Ä…czenie depth mapy do datasetu.

Etap 2 â€“ dodanie map QP i flag filtrÃ³w z CSV.

Etap 3 â€“ dodanie trybÃ³w predykcji.

Etap 4 â€“ dodanie zdekwantowanych wspÃ³Å‚czynnikÃ³w z .bin.

Etap 5 â€“ modyfikacja modelu i testy wpÅ‚ywu poszczegÃ³lnych cech.

Etap 6 â€“ optymalizacja (np. normalizacja cech, dobÃ³r architektury).

7ï¸âƒ£ Wyniki i analiza
PorÃ³wnanie jakoÅ›ci rekonstrukcji z i bez dodatkowych cech.

Analiza, ktÃ³re cechy najbardziej pomagajÄ….

Wizualizacje map cech dla przykÅ‚adowych ramek.



DLACZEGO TEN RECON YUV? - recon.yuv to wÅ‚aÅ›nie wynikowy film dekodera.



czyli do rozpoczÄ™cia prac nad sieciÄ… i eksperymentami muszÄ™:

1. pobraÄ‡ dataset y4m
2. przekonwertowaÄ‡ go na maÅ‚e filmy o dÅ‚ugoÅ›ci 64 klatek w formacie yuv (+ plus plik .info do kaÅ¼dego filmu Å¼eby odczytywaÄ‡ z niego wartoÅ›ci)
3. przekodowaÄ‡ te filmy za pomocÄ… vvenc i czytajÄ…c pliki info w rÃ³Å¼nych wariantach, tj. AI, RA, przeÅ‚Ä…czajÄ…c filtry.
4. rozkodowaÄ‡ powstaÅ‚e w ten sposÃ³b pliki vvc do odpowiednich lokalizacji aby mieÄ‡: 
- recony
- csv ze statami blokÃ³w
- csv z zdekwantowanymi wspÃ³Å‚czynnikami per klatka
5. od razu przy dekodowaniu uÅ¼yÄ‡ skryptÃ³w aby sparsowaÄ‡ te dane z csv aby mieÄ‡ gotowe dane do uczenia sieci


propozycja chata:

JeÅ›li chcesz, mogÄ™ Ci od razu rozpisaÄ‡ skrypt dekodujÄ…co-parsujÄ…cy, ktÃ³ry w jednym kroku:

odpali VTM z odpowiednimi parametrami,

odczyta block_stats.csv i dequant_poc_*.csv,

zapisze to jako gotowy zestaw cech (.npz) pod dany recon.

To by Ci skrÃ³ciÅ‚o punkt 4 i 5 do jednego polecenia.

Pliki .npz to po prostu spakowane (skompresowane) archiwa NumPy, ktÃ³re mogÄ… przechowywaÄ‡ wiele macierzy / tensorÃ³w w jednym pliku.



"Powiedz tylko, czy na start robimy tylko Y (luma) wspÃ³Å‚czynniki, czy od razu Y+Cb+Cr."